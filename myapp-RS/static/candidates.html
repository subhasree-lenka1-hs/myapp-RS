<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Candidates</title>
 <style>
    body {
    font-family: Arial, sans-serif;
    background: url('/static/images/background1.jpg') no-repeat center center fixed;
    background-size: cover;
    margin: 0;
    padding: 0;
    display: flex;
    height: 100vh;
    overflow: hidden;
}

.container {
    display: flex;
    width: 100%;
    height: 100%;
    flex-direction: row;
    overflow: hidden;
}

.sidebar {
    width: 300px;
    background: rgba(255, 255, 255, 0.9);
    padding: 20px;
    border-right: 1px solid #ddd;
    box-shadow: 4px 0 8px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

.sidebar h1 {
    text-align: center;
    color: #333;
    font-size: 2em;
    margin-bottom: 20px;
}

.candidate {
    margin-bottom: 15px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.candidate p {
    margin: 0;
    font-size: 1em;
}

.candidate button {
    padding: 8px 12px;
    background-color: #14a0b1;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    transition: background-color 0.3s ease;
}

.candidate button:hover {
    background-color: #0056b3;
}

.chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
}

.chat-header {
    font-size: 1.5em;
    padding: 15px;
    background-color: #14a0b1;
    color: #fff;
    font-weight: bold;
    text-align: center;
    border-bottom: 1px solid #0056b3;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: #f1f1f1;
    display: flex;
    flex-direction: column;
}

.chat-input {
    padding: 10px;
    background: #fff;
    border-top: 1px solid #ddd;
    box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    position: sticky;
    bottom: 0;
    z-index: 1;
    width: 100%;
    box-sizing: border-box; 
}

.chat-input input {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1em;
    width: 100%;
    box-sizing: border-box;
}

.chat-input button {
    padding: 10px 20px;
    background-color: #14a0b1;
    color: #fff;
    border: none;
    border-radius: 4px;
    margin-left: 10px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    white-space: nowrap; 
}

.chat-input button:hover {
    background-color: #0056b3;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.chat-input button:active {
    background-color: #004085;
}

.received-message {
    max-width: 80%;
    padding: 10px;
    border-radius: 15px;
    margin-bottom: 10px;
    background-color: #ffffff;
    align-self: flex-start;
    text-align: left;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.sent-message {
    max-width: 80%;
    padding: 10px;
    border-radius: 15px;
    margin-bottom: 10px;
    background-color: #14a0b1;
    color: #fff;
    align-self: flex-end;
    text-align: right;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.close-chat {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #ff4d4d;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 1.2em;
    transition: background-color 0.3s ease;
}

.close-chat:hover {
    background-color: #cc0000;
}

.chat-messages {
    flex: 1;
    overflow-y: auto; 
    padding: 15px;
    background: #f1f1f1;
    display: flex;
    flex-direction: column;
}

@media (max-width: 768px) {
    .container {
        flex-direction: column;
    }

    .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #ddd;
        box-shadow: none;
    }

    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%; 
    }

    .chat-input {
        flex-direction: column;
        padding: 10px;
        border-top: none;
        box-shadow: none;
    }

    .chat-input input {
        width: 100%;
        margin-bottom: 10px;
    }

    .chat-input button {
        width: 100%;
        margin-left: 0;
    }
}

@media (max-width: 480px) {
    .sidebar {
        padding: 10px;
        width: 100%;
    }

    .chat-header {
        font-size: 1.2em;
    }

    .chat-input {
        flex-direction: column;
        padding: 5px;
    }

    .chat-input input {
        font-size: 0.9em;
        margin-bottom: 5px;
    }

    .chat-input button {
        font-size: 0.9em;
        padding: 8px 16px;
        margin-left: 0;
        margin-top: 5px;
        width: 100%;
        box-sizing: border-box;
    }

    .received-message, .sent-message {
        max-width: 100%;
        font-size: 0.9em;
    }

    .close-chat {
        width: 25px;
        height: 25px;
        font-size: 1em;
        top: 5px;
        right: 5px;
    }
}


 </style>
</head>

<body>
    <div class="container">
        <div class="sidebar">
            <h1>All Candidates</h1>
            <p id="userEmail"></p>
            {{range .Candidates}}
            <div class="candidate">
                <div>
                    <p>{{.Name}}</p>
                    <p>{{.Email}}</p>
                </div>
                <button class="chat-button" onclick="startChat('{{.Email}}')">Chat</button>
            </div>
            {{end}}
            <p><a href="/recruiter_dashboard" class="button">Back to Dashboard</a></p>
        </div>
        <div class="chat-area">
            <button class="close-chat" onclick="closeChat()">Ã—</button>
            <div id="chatHeader" class="chat-header">
               
            </div>
            <div id="chatMessages" class="chat-messages"></div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Type your message...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let currentEmail = '';
        let currentChat = '';
        const chatHeader = document.getElementById('chatHeader');
        const chatMessages = document.getElementById('chatMessages');

        async function fetchUserEmail() {
            try {
                const response = await fetch('/user-email');
                const data = await response.json();
                return data.email || '';
            } catch (error) {
                console.error('Failed to fetch user email:', error);
                return '';
            }
        }

        async function fetchChatHistoryHandler(email) {
            try {
                const response = await fetch(`/fetch-chat-history?email=${encodeURIComponent(email)}`);
                const messages = await response.json();
                return messages;
            } catch (error) {
                console.error('Failed to fetch chat history:', error);
                return [];
            }
        }

        async function initializeUser() {
            currentEmail = await fetchUserEmail();
            if (!currentEmail) {
                console.error('User email is not set. Please check the login process.');
            }
        }

        async function startChat(email) {
            if (socket) {
                socket.close();
            }

            currentChat = email;
            chatHeader.textContent = `Chat with ${email}`;
            chatMessages.innerHTML = '';

            const previousMessages = await fetchChatHistoryHandler(email);
            if (previousMessages) {
                previousMessages.forEach(msg => {
                    if (msg.sender === currentEmail || msg.recipient === currentEmail) {
                        const messageDiv = document.createElement('div');
                        messageDiv.textContent = `${msg.sender === currentEmail ? 'You' : msg.sender}: ${msg.message}`;
                        messageDiv.classList.add(msg.sender === currentEmail ? 'sent-message' : 'received-message');
                        chatMessages.appendChild(messageDiv);
                    }
                });
                chatMessages.scrollTop = chatMessages.scrollHeight; // Ensure the chat scrolls to the bottom
            }

            const wsUrl = `ws://localhost:8080/ws`;
            socket = new WebSocket(wsUrl);

            socket.onopen = function (event) {
                console.log('WebSocket connection established:', event);
            };

            socket.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);
                    if ((data.sender !== currentEmail && data.recipient === currentChat) ||
                        (data.sender === currentChat && data.recipient === currentEmail)) {

                        const messageDiv = document.createElement('div');
                        messageDiv.textContent = `${data.sender}: ${data.message}`;
                        messageDiv.classList.add('received-message');
                        chatMessages.appendChild(messageDiv);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                } catch (e) {
                    console.error('Failed to parse message data:', e);
                }
            };


            socket.onerror = function (event) {
                console.error('WebSocket error observed:', event);
            };

            socket.onclose = function (event) {
                console.log('WebSocket connection closed:', event);
            };
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value;
            if (socket && message) {
                const messageData = {
                    sender: currentEmail,
                    recipient: currentChat,
                    message: message,
                    timestamp: new Date().toISOString()
                };
                const messageDiv = document.createElement('div');
                messageDiv.textContent = `You: ${message}`;
                messageDiv.classList.add('sent-message');
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                socket.send(JSON.stringify(messageData));

                fetch('/save_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messageData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to save message');
                        }
                    })
                    .catch(error => console.error('Error:', error));

                messageInput.value = '';
            }
        }

        function closeChat() {
            chatHeader.textContent = '';
            chatMessages.innerHTML = '';
            if (socket) {
                socket.close();
                socket = null;
            }
            currentChat = '';
        }

        initializeUser();
    </script>
</body>

</html>
